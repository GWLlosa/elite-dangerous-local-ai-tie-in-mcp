# EDCoPilot Chatter File Format Analysis

## Date: 2025-10-11
## Purpose: Comprehensive comparison between authoritative EDCoPilot format and our implementation

---

## Executive Summary

**CRITICAL FINDINGS:**
1. **Space Chatter Format is COMPLETELY WRONG** - We use conversation blocks `[example]...[\example]`, but this is ONLY for Crew Chatter
2. **Space Chatter should be simple lines** - No `[example]` blocks, no conditions in parentheses or brackets
3. **Comments ARE NOT SUPPORTED** - EDCoPilot parser rejects ALL comment lines (lines starting with `#`)
4. **Tokens use angle brackets** - `<token>` not `{token}` in final output
5. **Conditions use parentheses** - `(not-deep-space)` format, inline with dialogue

---

## Authoritative Format (from EDCoPilot default files)

### Space Chatter Format

**File:** `EDCoPilot.SpaceChatter.txt`

**Structure:**
```
[example]
[<speaker>] dialogue with <tokens>
[<speaker>] dialogue with <tokens>
[\example]

[example]
[<speaker>] dialogue with <tokens>
[\example]
```

**Key Observations:**
1. Uses **conversation blocks** with `[example]` and `[\example]` markers
2. Each line within a block has a **speaker role**: `[<ship1>]`, `[<ship2>]`, `[<stationname>]`
3. Tokens use **angle brackets**: `<cmdrname>`, `<myshipname>`, `<stationname>`, `<callsign>`, `<localdestination>`, `<flightnum>`, `<starsystem>`, `<randomstarsystem>`, `<fuellevels>`, `<shipCorporation>`, `<othercallsign>`
4. **NO COMMENTS** - Not a single comment line in the entire default file
5. **NO CONDITION SYNTAX** in default space chatter

### Crew Chatter Format

**File:** `EDCoPilot.CrewChatter.txt`

**Structure:**
```
[example]
[<CrewRole>] dialogue with <tokens>
[<CrewRole>] dialogue with <tokens>
[\example]

[example] (condition)
[<CrewRole>] dialogue
[\example]
```

**Key Observations:**
1. Uses **same conversation block format** as Space Chatter
2. Crew roles: `[<Helm>]`, `[<EDCoPilot>]`, `[<Engineering>]`, `[<Operations>]`, `[<Number1>]`, `[<Science>]`, `[<Comms>]`, `[<Security>]`
3. Tokens: `<cmdrname>`, `<fuellevels>`, and same space tokens
4. **Conditions appear INLINE with [example] tag**: `[example] (not-station)`
5. **NO COMMENTS** in default file
6. Note: Line 15 has `[/example]` (forward slash) which appears to be a typo

### Deep Space Chatter Format

**File:** `EDCoPilot.DeepSpaceChatter.txt` (user custom backup)

**Structure:**
```
[example] [<CrewRole>]: "dialogue in quotes"
[<CrewRole>]: "dialogue in quotes"
[\example]
```

**Key Observations:**
1. Uses **conversation blocks** like Crew Chatter
2. Optional **quoted dialogue** with colon separator
3. Very simple, philosophical/atmospheric content
4. **NO COMMENTS** in backup file

---

## Our Current Implementation

### What We Generate

**File:** `EDCoPilot.SpaceChatter.Custom.txt`

```
# EDCoPilot Space Chatter Custom File
# Generated by Elite Dangerous MCP Server
# Format: (ConditionName) Dialogue text with <Tokens>
# Simple format: Dialogue text
#
# Available Tokens: <CommanderName>, <SystemName>, <ShipName>, <FuelPercent>, etc.
# Available Conditions: Docked, InSupercruise, UnderAttack, Scanning, etc.
#

(InSupercruise) Entering <SystemName>, Commander. Scanning for points of interest.
(Docked) Successfully docked at <StationName>. All systems secure.
(FuelLow) Fuel reserves at <FuelPercent>%. Recommend refueling soon, Commander.
```

### What's Wrong

1. **HEADER COMMENTS** - ALL 9 header lines are rejected as "bad line"
2. **WRONG FORMAT** - Space Chatter should use `[example]` conversation blocks, NOT single lines
3. **NO SPEAKER ROLES** - Missing `[<ship1>]`, `[<stationname>]`, etc.
4. **CONDITION SYNTAX** - Using `(Condition)` might be correct per docs, but not used in default Space Chatter
5. **TOKEN NAMES** - Using `<SystemName>`, `<StationName>` instead of `<starsystem>`, `<stationname>`

---

## Comparison Matrix

| Feature | Authoritative | Our Implementation | Status |
|---------|--------------|-------------------|--------|
| **Space Chatter Structure** | `[example]` blocks | Single lines with conditions | WRONG |
| **Crew Chatter Structure** | `[example]` blocks | (Not checked yet) | ? |
| **Comments Support** | NO - not present | YES - header comments | WRONG |
| **Speaker Roles** | `[<ship1>]`, `[<stationname>]` | None | MISSING |
| **Token Format** | `<lowercase>` | `<TitleCase>` | INCONSISTENT |
| **Condition Format** | `(not-deep-space)` inline | `(Condition)` prefix | PARTIALLY WRONG |
| **Blank Lines** | Between conversations | After header | OK |

---

## Token Mapping Issues

### Authoritative Tokens (from default files)
- `<cmdrname>` - Commander name
- `<cmdraddress>` - Sir/Ma'am/Commander
- `<myshipname>` - Ship name
- `<stationname>` - Station name
- `<starsystem>` - Current system
- `<randomstarsystem>` - Random system for dialogue variety
- `<callsign>` - Ship callsign
- `<localdestination>` - Local destination
- `<flightnum>` - Flight number
- `<fuellevels>` - Fuel level percentage
- `<shipCorporation>` - Ship corporation
- `<othercallsign>` - Another ship's callsign

### Our Token Names (what we generate)
- `<CommanderName>` - Should be `<cmdrname>`
- `<SystemName>` - Should be `<starsystem>`
- `<StationName>` - Should be `<stationname>`
- `<ShipName>` - Should be `<myshipname>`
- `<FuelPercent>` - Should be `<fuellevels>` (different meaning)
- `<BodyName>` - No equivalent
- `<Credits>` - No equivalent in default files
- `<ShieldPercent>` - No equivalent
- `<HullPercent>` - No equivalent

---

## Root Cause of Errors

### Why EDCoPilot Rejects Our Files

From `EDCoPilotGUI2.log.20251011.215128.txt`:
```
WARNING - bad line in C:\Utilities\EDCoPilot/User custom files\EDCoPilot.SpaceChatter.Custom.txt at line 1 : # EDCoPilot Space Chatter Custom File.
WARNING - bad line ... at line 10 : (InSupercruise) Entering <SystemName>, Commander. Scanning for points of interest.
```

**Analysis:**
1. **Line 1-9**: Rejected because comments are not supported
2. **Line 10+**: Rejected because format is wrong (should be conversation blocks, not single lines)

The EDCoPilot parser expects:
- `[example]` to start a conversation
- `[<speaker>]` lines with dialogue
- `[\example]` to end a conversation

It does NOT expect:
- Comment lines starting with `#`
- Single-line conditional dialogue like `(Condition) Text`

---

## Correct Implementation Should Be

### For Space Chatter

```
[example]
[<ship1>] <stationname> control, requesting docking clearance.
[<stationname>] <callsign>, this is <stationname> control. Sending landing pad assignment now.
[<ship1>] Copy that, proceeding to pad.
[\example]

[example]
[<ship1>] Control, <myshipname> departing station. o7 commanders.
[<stationname>] Safe travels, <cmdrname>. See you soon.
[\example]
```

### For Crew Chatter

```
[example]
[<Operations>] Commander <cmdrname>, fuel reserves at <fuellevels> percent.
[<EDCoPilot>] Acknowledged. Plotting course to nearest fuel source.
[<Helm>] Course laid in, awaiting your orders <cmdraddress>.
[\example]

[example] (not-station)
[<Engineering>] We're <distancefromsol> light years from Sol. Deep space operations.
[<Science>] Long-range scans show nothing of immediate concern.
[\example]
```

### NO COMMENTS ANYWHERE

Comments are not part of the EDCoPilot file format. The parser rejects them.

---

## Grammar Specification Errors

### What Our `docs/edcopilot-chatter-grammar.md` Says

**Line 36-38:**
```
#### For Space Chatter (Single Line Format)
[optional_condition] dialogue_text
```

**This is WRONG.** Space Chatter does NOT use single-line format. It uses conversation blocks.

**Line 142-150 (File Header Template):**
```
# EDCoPilot [Type] Custom File
# Generated by Elite Dangerous MCP Server
# Format: [condition]|[voice]|dialogue_text
#
# Available Tokens: {dynamic_token_list}
```

**This is WRONG.** EDCoPilot does not support comments at all.

**Line 190-198 (Conditional Examples):**
```
# Only when docked
(Docked) Permission to disembark granted, <cmdraddress>

# Only when in supercruise
(InSupercruise) Dropping out of supercruise, <cmdraddress>
```

**This is WRONG.** These examples use single-line format that doesn't match authoritative files.

---

## Required Fixes

### 1. Grammar Specification Document
- **REWRITE** Space Chatter format section
- **REMOVE** all references to comments
- **ADD** conversation block format examples
- **UPDATE** token names to match authoritative format
- **CORRECT** condition syntax (inline with `[example]`, not line prefix)

### 2. Templates Implementation (`src/edcopilot/templates.py`)
- **CHANGE** Space Chatter to use conversation blocks
- **ADD** speaker role system for space chatter
- **REMOVE** single-line conditional format
- **FIX** token names to match authoritative
- **REMOVE** all comment generation code

### 3. Generator Implementation (`src/edcopilot/generator.py`)
- **REMOVE** `to_file_content()` header comment generation
- **UPDATE** token replacement to use lowercase names
- **ADD** conversation block construction
- **ADD** speaker role assignment

### 4. Tests
- **UPDATE** all test assertions expecting comments
- **UPDATE** all test assertions expecting single-line format
- **ADD** tests validating conversation block structure
- **ADD** tests validating speaker roles

---

## Impact Assessment

### Severity: CRITICAL - Complete Format Mismatch

**Current State:**
- 100% of generated Space Chatter files are rejected
- 100% of generated Crew Chatter files may also be wrong
- Users cannot use MCP-generated chatter files at all

**After Fix:**
- Files will load correctly into EDCoPilot
- Chatter will actually play during gameplay
- No "bad line" warnings in logs

### Files Requiring Changes

1. `docs/edcopilot-chatter-grammar.md` - Complete rewrite of Space Chatter section
2. `src/edcopilot/templates.py` - Major refactor of Space Chatter template
3. `src/edcopilot/generator.py` - Remove comment generation
4. `tests/unit/test_templates.py` - Update all assertions
5. `tests/unit/test_generator.py` - Update all assertions
6. `tests/integration/` - Update end-to-end tests

### Breaking Changes

This is a breaking change that affects:
- All existing generated chatter files (must be regenerated)
- All tests expecting old format
- All documentation referencing old format

---

## Recommendations

### Immediate Actions

1. **Update GitHub Issue #20** with these authoritative findings
2. **Create new issue** for grammar specification rewrite
3. **Prioritize as CRITICAL** - core feature is completely broken
4. **Do NOT merge** any chatter-related PRs until fixed

### Long-term Improvements

1. **Add format validation** - Check generated files match EDCoPilot format
2. **Add integration tests** - Actual EDCoPilot parsing validation
3. **Research token behavior** - Do custom tokens work? Are there undocumented tokens?
4. **Document speaker roles** - What speakers are available? What do they do?

---

## Conclusion

Our entire EDCoPilot chatter generation system is based on an incorrect understanding of the file format. The grammar specification document was created without examining actual EDCoPilot files, leading to a completely non-functional implementation.

**Priority:** Fix this before ANY other EDCoPilot work.
**Complexity:** High - requires significant refactoring.
**Risk:** Low - current implementation doesn't work anyway.

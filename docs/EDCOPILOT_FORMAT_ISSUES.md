# EDCoPilot File Format Issues and Solutions

## **Critical Issue Discovered**

During troubleshooting user reports that EDCoPilot was rejecting generated custom files, we discovered multiple critical format violations in our EDCoPilot integration. EDCoPilot logs showed "WARNING - bad line" errors for every line in our generated files.

## **Root Cause Analysis**

### **Primary Format Violations**

1. **Wrong Condition Syntax for Space Chatter**
   - **Generated (INCORRECT):** `condition:InSupercruise|Entering {SystemName}, Commander...`
   - **Required (CORRECT):** `Entering <SystemName>, Commander...` OR `(InSupercruise) Entering <SystemName>, Commander...`

2. **Wrong Format for Crew Chatter**
   - **Generated (INCORRECT):** Single-line format with `condition:` prefix
   - **Required (CORRECT):** Conversation blocks with speaker roles:
     ```
     [example]
     [<Operations>] Navigation officer reports jump calculations complete, Commander
     [<EDCoPilot>] Acknowledged, Sir
     [\example]
     ```

3. **Wrong Token Format**
   - **Generated (INCORRECT):** `{SystemName}`, `{StationName}`, `{FuelPercent}`
   - **Required (CORRECT):** `<SystemName>`, `<StationName>`, `<FuelLevel>`

4. **Missing Required Conversation Structure**
   - Crew Chatter requires `[example]`/`[\example]` blocks
   - Speaker roles must use format: `[<RoleName>]`
   - Current implementation uses invalid single-line format

## **EDCoPilot Log Evidence**

```
WARNING - bad line in C:\Utilities\EDCoPilot/User custom files\EDCoPilot.SpaceChatter.Custom.txt at line 1 : # EDCoPilot Space Chatter Custom File.
WARNING - bad line in C:\Utilities\EDCoPilot/User custom files\EDCoPilot.SpaceChatter.Custom.txt at line 2 : # Generated by Elite Dangerous MCP Server.
WARNING - bad line in C:\Utilities\EDCoPilot/User custom files\EDCoPilot.SpaceChatter.Custom.txt at line 5 : # Available Tokens: {CommanderName}, {SystemName}, {ShipName}, {FuelPercent}, etc.
```

**Every single line** was being rejected as invalid syntax.

## **Grammar Specification Compliance**

### **Space Chatter Format**
- **Simple:** `Dialogue text here`
- **Conditional:** `(Condition) Dialogue text here`
- **NO condition: prefix allowed**

### **Crew Chatter Format**
```
[example]
[<Speaker>] Dialogue line
[<Speaker>] Response line
[\example]
```

### **Token Format**
- Use `<TokenName>` not `{TokenName}`
- Valid tokens: `<SystemName>`, `<StationName>`, `<CommanderName>`, etc.

### **Speaker Roles**
- `[<EDCoPilot>]` - Ship's computer
- `[<Operations>]` - Operations officer
- `[<Helm>]` - Helm officer
- `[<Engineering>]` - Chief engineer
- `[<Comms>]` - Communications officer
- `[<Science>]` - Science officer
- `[<Security>]` - Security chief

## **Test Suite Implementation**

### **Unit Tests Created**
- `tests/unit/test_edcopilot_format_validation.py` - Comprehensive format validation
- `tests/integration/test_edcopilot_grammar_compliance.py` - End-to-end grammar compliance

### **Test Coverage**
- Space Chatter format compliance
- Crew Chatter conversation structure
- Token format validation
- Speaker role validation
- Comment header validation
- No parsing error validation
- End-to-end file generation compliance

## **Fix Requirements**

### **Immediate Actions Needed**

1. **Rewrite Template Generation Logic**
   - Fix `src/edcopilot/templates.py` to use correct formats
   - Remove all `condition:` prefix usage
   - Implement proper conversation blocks for crew chatter
   - Convert all `{token}` to `<token>` format

2. **Token Replacement System**
   - Update token patterns from `{Token}` to `<Token>`
   - Ensure all game data integration uses correct format
   - Handle missing data gracefully with appropriate fallbacks

3. **File Structure Compliance**
   - Space Chatter: Simple dialogue lines or `(Condition) dialogue`
   - Crew Chatter: Conversation blocks with speaker roles
   - Deep Space Chatter: Either format acceptable
   - Minimal comment headers to avoid parsing issues

### **Implementation Standards**

```python
# CORRECT Space Chatter Generation
def generate_space_chatter_line(condition: str, dialogue: str) -> str:
    if condition:
        return f"({condition}) {dialogue}"
    else:
        return dialogue

# CORRECT Crew Chatter Generation
def generate_crew_conversation() -> str:
    return """[example]
[<Operations>] Navigation officer reports jump calculations complete, Commander
[<EDCoPilot>] Acknowledged, <cmdraddress>
[\\example]"""

# CORRECT Token Replacement
def replace_tokens(content: str, game_state) -> str:
    replacements = {
        "<SystemName>": game_state.current_system or "Unknown System",
        "<StationName>": game_state.current_station or "Station",
        "<CommanderName>": game_state.commander_name or "Commander"
    }
    for token, value in replacements.items():
        content = content.replace(token, value)
    return content
```

## **Quality Assurance**

### **Testing Requirements**
1. All generated files must pass format validation tests
2. No "bad line" warnings in EDCoPilot logs
3. Grammar compliance tests must pass 100%
4. Token replacement must work correctly
5. Files must load successfully in EDCoPilot

### **Validation Process**
1. Generate test files with current implementation
2. Run format validation test suite
3. Test with actual EDCoPilot installation
4. Monitor EDCoPilot logs for parsing errors
5. Verify functionality in game

## **Documentation Updates Required**

- Update grammar specification with confirmed requirements
- Add troubleshooting section for format issues
- Include EDCoPilot log analysis procedures
- Document proper testing methodology
- Update implementation examples

## **Impact Assessment**

**Critical Impact:** EDCoPilot integration completely non-functional due to format violations. All generated files are rejected by EDCoPilot parser, making the feature unusable.

**Resolution Priority:** Highest - blocks core functionality of EDCoPilot integration milestone.

## **Prevention Measures**

1. **Comprehensive Test Suite** - Validates against actual EDCoPilot grammar
2. **Format Validation** - Checks every generated line for compliance
3. **Integration Testing** - Tests with real EDCoPilot installation
4. **Log Monitoring** - Automated checking of EDCoPilot logs for errors
5. **Grammar Specification Compliance** - Strict adherence to documented format

---

**Created:** September 18, 2025
**Status:** Critical Issue - Requires Immediate Fix
**Priority:** P0 - Blocks EDCoPilot Integration Functionality